(function(a){a.extend({head:function(b,d,e,c){if(a.isFunction(d)){e=d;d={}}if(c==undefined){c=2000}return a.ajax({type:"HEAD",url:b,data:d,timeout:c,complete:function(i,k){var j=i.getAllResponseHeaders().split("\n");var f={};var g=j.length;for(var h=0;h<g;h++){if(j[h].length!=0){header=j[h].split(": ");f[header[0]]=header[1]}}if(a.isFunction(e)){e(f)}}})}})})(jQuery);jQuery.cookie=function(b,j,m){if(typeof j!="undefined"){m=m||{};if(j===null){j="";m.expires=-1}var e="";if(m.expires&&(typeof m.expires=="number"||m.expires.toUTCString)){var f;if(typeof m.expires=="number"){f=new Date();f.setTime(f.getTime()+(m.expires*24*60*60*1000))}else{f=m.expires}e="; expires="+f.toUTCString()}var l=m.path?"; path="+(m.path):"";var g=m.domain?"; domain="+(m.domain):"";var a=m.secure?"; secure":"";document.cookie=[b,"=",encodeURIComponent(j),e,l,g,a].join("")}else{var d=null;if(document.cookie&&document.cookie!=""){var k=document.cookie.split(";");for(var h=0;h<k.length;h++){var c=jQuery.trim(k[h]);if(c.substring(0,b.length+1)==(b+"=")){d=decodeURIComponent(c.substring(b.length+1));break}}}return d}};function getCookie(a){var b=document.cookie.match("\\b"+a+"=([^;]*)\\b");return b?b[1]:undefined}jQuery.fn.formToDict=function(){var a=this.serializeArray();var c={};for(var b=0;b<a.length;b++){c[a[b].name]=a[b].value}if(c.next){delete c.next}return c};jQuery.fn.disable=function(){this.enable(false);return this};jQuery.fn.enable=function(a){if(arguments.length&&!a){this.attr("disabled","disabled")}else{this.removeAttr("disabled")}return this};var activity={errorSleepTime:5000,cursor:null,host:null,port:null,instance:null,room:null,destination:null,user:null,users:null,registry:null,construct:function(){activity.host=$("#host").html();activity.port=parseInt($("#port").html())+13090;activity.instance=$("#instance").html();activity.room=$("#room").html();activity.film=$("#film").html();activity.destination=activity.host+":"+activity.port;activity.user=$("#userid").html();activity.users=new Array();activity.registry=new Array()},init:function(){if($("#noauth").length!=0){return}if(activity.room==""){return}var a={room:activity.room,instance:activity.instance,userid:activity.user,location:activity.location,cookie:$.cookie("constellation_frontend")};$.ajax({url:"/services/activity/init?i="+activity.destination,type:"GET",cache:false,dataType:"text",data:$.param(a),success:activity.onInitSuccess,error:activity.onInitError})},onInitSuccess:function(response){try{if(!response){return}var response=eval("("+response+")");activity.tempusers=new Array();for(var i=0;i<response.users.length;i++){if(response.users[i].userid!=undefined){activity.pushUser(response.users[i]);activity.showUser(response.users[i])}}if(activity.users.length>activity.tempusers.length){for(var i=0;i<activity.users.length;i++){activity.dropUser(activity.users[i])}}activity.showUserCount()}catch(e){console.log("Activity Error");activity.onInitError();return}},onInitError:function(a){console.log("Activity Init Error");window.setTimeout(activity.init,5000)},pushUser:function(a){if(a.userid==undefined){return}activity.tempusers.push(a.userid);if($.inArray(a.userid,activity.users)==-1){activity.users.push(a.userid);activity.registry[a.userid]=a.username}},dropUser:function(a,b){if($.inArray(a,activity.tempusers)==-1){activity.removeUser(a);delete activity.registry[a];activity.users=jQuery.grep(activity.users,function(c){return c!=a})}},announce:function(){if($("#noauth").length!=0){return}if(activity.room==""){return}var a={film:activity.film,room:activity.room,instance:activity.instance,userid:activity.user,location:activity.location,cookie:$.cookie("constellation_frontend")};$.ajax({url:"/services/activity/announce?i="+activity.destination,type:"POST",cache:false,dataType:"text",data:$.param(a),success:activity.onAnnounceSuccess,error:activity.onAnnounceError})},onAnnounceSuccess:function(response){try{var response=eval("("+response+")");activity.showUser(response.users[0]);activity.tempusers=new Array();activity.pushUser(response.users[0]);activity.showUserCount()}catch(e){activity.onAnnounceError();return}},onAnnounceError:function(a){console.log("Activity Announce Error");window.setTimeout(activity.announce,5000)},status:function(){if($("#noauth").length!=0){return}if(activity.room==""){return}try{var a="/services/activity/status?i="+activity.destination+"&room="+activity.room+"&userid="+activity.user+"&instance="+activity.instance+"&location="+activity.location+"&film="+activity.film+"&cookie="+$.cookie("constellation_frontend");$.head(a,{},function(c){$.each(c,function(d,g){if(d=="X-User-Get"){try{if(g!=activity.users.length){activity.init()}}catch(f){}}if(d=="X-Server-Time"){try{timekeeper.poll(g)}catch(f){}}});window.setTimeout(activity.status,5000)},activity.errorSleepTime-2000)}catch(b){window.setTimeout(activity.status,5000)}},poll:function(){if($("#noauth").length!=0){return}if(activity.room==""){return}var a={room:$("#room").html(),userid:$("#userid").html(),location:activity.location,cookie:$.cookie("constellation_frontend")};$.ajax({url:"/services/activity/update?i="+activity.destination,type:"POST",cache:false,dataType:"text",data:$.param(a),timeout:activity.errorSleepTime,success:activity.onPollSuccess,error:activity.onPollError})},onPollSuccess:function(response){try{if(!response){return}var response=eval("("+response+")");for(var i=0;i<response.users.length;i++){activity.showUser(response.users[i],true)}}catch(e){activity.onAnnounceError();return}activity.errorSleepTime=100;window.setTimeout(activity.poll,0)},onPollError:function(a){console.log("Activity Poll error; sleeping for",activity.errorSleepTime,"ms");window.setTimeout(activity.poll,activity.errorSleepTime)},showUserCount:function(){if($("#userCount").length>0){$("#userCount").html(activity.users.length)}},showUser:function(b){if($("#adminmessage-users").length>0){var a="green";if(b.location=="lobby"){a="orange"}if($("#adminuser-"+b.userid).length>0){userdata='<a name="adminmessageuser-'+b.userid+'" id="adminmessageuser-'+b.userid+'" title="'+b.username+'" onClick="adminmessage.startAdminChat(this)"><img src="/images/Neu/8x8/status/online-'+a+'.png" /></a>';$("#adminuser-"+b.userid+"-status").html(userdata)}else{html='<div class="message" id="adminuser-'+b.userid+'"><span id="adminuser-'+b.userid+'-block"><a name="adminmessageuser-'+b.userid+'" id="blockmessageuser-'+b.userid+'" title="'+b.username+'" onClick="adminmessage.blockSeat(this)"><img src="/images/Neu/8x8/status/important.png" /></a></span><span id="adminuser-'+b.userid+'-status"><a name="adminmessageuser-'+b.userid+'" id="adminmessageuser-'+b.userid+'" title="'+b.username+'" onClick="adminmessage.electAdminChat(this)"><img src="/images/Neu/8x8/status/online-'+a+'.png" /></a></span><strong>'+b.username+"</strong></div>";$("#adminmessage-users").append(html)}}if($("#user-"+b.userid).length==0){var d=Math.floor(Math.random()*98);var c=Math.floor(Math.random()*121);html='<a style="position: relative; top: '+c+"px; left: "+d+'%;" name="constellation-'+b.userid+'" class="host-star" id="user-'+b.userid+'" title="'+b.username+'" onClick="privatechat.startPrivateChat(this)"><img src="/images/host-star.png" /></a>';$("#constellation_map").append(html)}},setUserLocation:function(c,d,a){var b="green";if(a=="lobby"){b="orange"}if($("#adminuser-"+userid).length>0){userdata='<a name="adminmessageuser-'+userid+'" id="adminmessageuser-'+userid+'" title="'+username+'" onClick="adminmessage.startAdminChat(this)"><img src="/images/Neu/8x8/status/online-'+b+'.png" /></a>';$("#adminuser-"+userid+"-status").html(userdata)}},removeUser:function(a){if($("#adminmessage-users").length==0){if($("#adminuser-"+a+"-status").length==0){$("#adminuser-"+a+"-status").html("Offline").attr("style","color:red")}}if(($("#user-"+a).length>0)&&(a!=$("#userid").html())){$("#user-"+a).remove()}}};$(document).ready(function(){if(!window.console){window.console={}}if(!window.console.log){window.console.log=function(){}}if(window.location.pathname.match(/theater/)){activity.location="theater"}if(window.location.pathname.match(/lobby/)){activity.location="lobby"}activity.construct();activity.init();activity.announce();activity.status()});