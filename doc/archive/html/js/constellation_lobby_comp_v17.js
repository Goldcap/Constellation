(function(a){a.extend({head:function(b,d,e,c){if(a.isFunction(d)){e=d;d={}}if(c==undefined){c=2000}return a.ajax({type:"HEAD",url:b,data:d,timeout:c,complete:function(i,k){var j=i.getAllResponseHeaders().split("\n");var f={};var g=j.length;for(var h=0;h<g;h++){if(j[h].length!=0){header=j[h].split(": ");f[header[0]]=header[1]}}if(a.isFunction(e)){e(f)}}})}})})(jQuery);jQuery.cookie=function(b,j,m){if(typeof j!="undefined"){m=m||{};if(j===null){j="";m.expires=-1}var e="";if(m.expires&&(typeof m.expires=="number"||m.expires.toUTCString)){var f;if(typeof m.expires=="number"){f=new Date();f.setTime(f.getTime()+(m.expires*24*60*60*1000))}else{f=m.expires}e="; expires="+f.toUTCString()}var l=m.path?"; path="+(m.path):"";var g=m.domain?"; domain="+(m.domain):"";var a=m.secure?"; secure":"";document.cookie=[b,"=",encodeURIComponent(j),e,l,g,a].join("")}else{var d=null;if(document.cookie&&document.cookie!=""){var k=document.cookie.split(";");for(var h=0;h<k.length;h++){var c=jQuery.trim(k[h]);if(c.substring(0,b.length+1)==(b+"=")){d=decodeURIComponent(c.substring(b.length+1));break}}}return d}};function getCookie(a){var b=document.cookie.match("\\b"+a+"=([^;]*)\\b");return b?b[1]:undefined}jQuery.fn.formToDict=function(){var a=this.serializeArray();var c={};for(var b=0;b<a.length;b++){c[a[b].name]=a[b].value}if(c.next){delete c.next}return c};jQuery.fn.disable=function(){this.enable(false);return this};jQuery.fn.enable=function(a){if(arguments.length&&!a){this.attr("disabled","disabled")}else{this.removeAttr("disabled")}return this};var activity={errorSleepTime:5000,cursor:null,host:null,port:null,instance:null,room:null,destination:null,user:null,users:null,registry:null,construct:function(){activity.host=$("#host").html();activity.port=parseInt($("#port").html())+13090;activity.instance=$("#instance").html();activity.room=$("#room").html();activity.film=$("#film").html();activity.destination=activity.host+":"+activity.port;activity.user=$("#userid").html();activity.users=new Array();activity.registry=new Array()},init:function(){if($("#noauth").length!=0){return}if(activity.room==""){return}var a={room:activity.room,instance:activity.instance,userid:activity.user,location:activity.location,cookie:$.cookie("constellation_frontend")};$.ajax({url:"/services/activity/init?i="+activity.destination,type:"GET",cache:false,dataType:"text",data:$.param(a),success:activity.onInitSuccess,error:activity.onInitError})},onInitSuccess:function(response){try{if(!response){return}var response=eval("("+response+")");activity.tempusers=new Array();for(var i=0;i<response.users.length;i++){if(response.users[i].userid!=undefined){activity.pushUser(response.users[i]);activity.showUser(response.users[i])}}if(activity.users.length>activity.tempusers.length){for(var i=0;i<activity.users.length;i++){activity.dropUser(activity.users[i])}}activity.showUserCount()}catch(e){console.log("Activity Error");activity.onInitError();return}},onInitError:function(a){console.log("Activity Init Error");window.setTimeout(activity.init,5000)},pushUser:function(a){if(a.userid==undefined){return}activity.tempusers.push(a.userid);if($.inArray(a.userid,activity.users)==-1){activity.users.push(a.userid);activity.registry[a.userid]=a.username}},dropUser:function(a,b){if($.inArray(a,activity.tempusers)==-1){activity.removeUser(a);delete activity.registry[a];activity.users=jQuery.grep(activity.users,function(c){return c!=a})}},announce:function(){if($("#noauth").length!=0){return}if(activity.room==""){return}var a={film:activity.film,room:activity.room,instance:activity.instance,userid:activity.user,location:activity.location,cookie:$.cookie("constellation_frontend")};$.ajax({url:"/services/activity/announce?i="+activity.destination,type:"POST",cache:false,dataType:"text",data:$.param(a),success:activity.onAnnounceSuccess,error:activity.onAnnounceError})},onAnnounceSuccess:function(response){try{var response=eval("("+response+")");activity.showUser(response.users[0]);activity.tempusers=new Array();activity.pushUser(response.users[0]);activity.showUserCount()}catch(e){activity.onError();return}},onAnnounceError:function(a){console.log("Activity Announce Error");window.setTimeout(activity.announce,5000)},status:function(){if($("#noauth").length!=0){return}if(activity.room==""){return}try{var a="/services/activity/status?i="+activity.destination+"&room="+activity.room+"&userid="+activity.user+"&instance="+activity.instance+"&location="+activity.location+"&film="+activity.film+"&cookie="+$.cookie("constellation_frontend");$.head(a,{},function(c){$.each(c,function(d,g){if(d=="X-User-Get"){try{if(g!=activity.users.length){activity.init()}}catch(f){}}if(d=="X-Server-Time"){try{timekeeper.poll(g)}catch(f){}}});window.setTimeout(activity.status,5000)},activity.errorSleepTime-2000)}catch(b){window.setTimeout(activity.status,5000)}},poll:function(){if($("#noauth").length!=0){return}if(activity.room==""){return}var a={room:$("#room").html(),userid:$("#userid").html(),location:activity.location,cookie:$.cookie("constellation_frontend")};$.ajax({url:"/services/activity/update?i="+activity.destination,type:"POST",cache:false,dataType:"text",data:$.param(a),timeout:activity.errorSleepTime,success:activity.onPollSuccess,error:activity.onPollError})},onPollSuccess:function(response){try{if(!response){return}var response=eval("("+response+")");for(var i=0;i<response.users.length;i++){activity.showUser(response.users[i],true)}}catch(e){activity.onError();return}activity.errorSleepTime=100;window.setTimeout(activity.poll,0)},onPollError:function(a){console.log("Activity Poll error; sleeping for",activity.errorSleepTime,"ms");window.setTimeout(activity.poll,activity.errorSleepTime)},showUserCount:function(){if($("#userCount").length>0){$("#userCount").html(activity.users.length)}},showUser:function(b){if($("#adminmessage-users").length>0){var a="green";if(b.location=="lobby"){a="orange"}if($("#adminuser-"+b.userid).length>0){userdata='<a name="adminmessageuser-'+b.userid+'" id="adminmessageuser-'+b.userid+'" title="'+b.username+'" onClick="adminmessage.startAdminChat(this)"><img src="/images/Neu/8x8/status/online-'+a+'.png" /></a>';$("#adminuser-"+b.userid+"-status").html(userdata)}else{html='<div class="message" id="adminuser-'+b.userid+'"><span id="adminuser-'+b.userid+'-block"><a name="adminmessageuser-'+b.userid+'" id="blockmessageuser-'+b.userid+'" title="'+b.username+'" onClick="adminmessage.blockSeat(this)"><img src="/images/Neu/8x8/status/important.png" /></a></span><span id="adminuser-'+b.userid+'-status"><a name="adminmessageuser-'+b.userid+'" id="adminmessageuser-'+b.userid+'" title="'+b.username+'" onClick="adminmessage.electAdminChat(this)"><img src="/images/Neu/8x8/status/online-'+a+'.png" /></a></span><strong>'+b.username+"</strong></div>";$("#adminmessage-users").append(html)}}if($("#user-"+b.userid).length==0){var d=Math.floor(Math.random()*98);var c=Math.floor(Math.random()*121);html='<a style="position: relative; top: '+c+"px; left: "+d+'%;" name="constellation-'+b.userid+'" class="host-star" id="user-'+b.userid+'" title="'+b.username+'" onClick="privatechat.startPrivateChat(this)"><img src="/images/host-star.png" /></a>';$("#constellation_map").append(html)}},setUserLocation:function(c,d,a){var b="green";if(a=="lobby"){b="orange"}if($("#adminuser-"+userid).length>0){userdata='<a name="adminmessageuser-'+userid+'" id="adminmessageuser-'+userid+'" title="'+username+'" onClick="adminmessage.startAdminChat(this)"><img src="/images/Neu/8x8/status/online-'+b+'.png" /></a>';$("#adminuser-"+userid+"-status").html(userdata)}},removeUser:function(a){if($("#adminmessage-users").length==0){if($("#adminuser-"+a+"-status").length==0){$("#adminuser-"+a+"-status").html("Offline").attr("style","color:red")}}if(($("#user-"+a).length>0)&&(a!=$("#userid").html())){$("#user-"+a).remove()}}};$(document).ready(function(){if(!window.console){window.console={}}if(!window.console.log){window.console.log=function(){}}if(window.location.pathname.match(/theater/)){activity.location="theater"}if(window.location.pathname.match(/lobby/)){activity.location="lobby"}activity.construct();activity.init();activity.announce();activity.status()});function newAdminMessage(c){var b=c.formToDict();b.type="chat";var a=c.find("input[type=submit]");a.disable();$.postAdminJSON("/services/adminmessage/post",b,function(d){adminmessage.showMessage(d);if(b.id){c.parent().remove()}else{c.find("input[type=text]").val("").select();a.enable()}})}jQuery.postAdminJSON=function(url,args,callback){if($("#adminmessage-pairid").html()==""){console.log("No Admin Pair ID");return}args.room=$("#room").html();args.location=$("#location").html();args.instance=$("#instance").html();args.author=$("#userid").html();args.pair=$("#adminmessage-pairid").html();args.to=$("#adminmessage-toid").html();$.ajax({url:url+"?i="+$("#host").html()+":"+(parseInt($("#port").html())+11090),data:$.param(args),type:"POST",cache:false,dataType:"text",success:function(response){if((callback)&&(response!="")){callback(eval("("+response+")"))}},error:function(response){console.log("ERROR:",response)}})};var adminmessage={errorSleepTime:5000,cursor:null,seatrequest:"I'd like to have your seat at this screening.",seatresponse:"You can have my seat at this screening.",showingtype:null,host:null,port:null,instance:null,room:null,user:null,destination:null,inbox:null,pair:null,to:null,seat:null,deadletter:0,construct:function(){adminmessage.host=$("#host").html();adminmessage.port=parseInt($("#port").html())+11090;adminmessage.instance=$("#instance").html();adminmessage.room=$("#room").html();adminmessage.user=$("#userid").html();adminmessage.destination=adminmessage.host+":"+adminmessage.port;adminmessage.inbox=$("#adminmessage-inbox");adminmessage.pair=$("#adminmessage-pairid").html();adminmessage.to=$("#adminmessage-toid").html();adminmessage.seat=$("#seat").html()},init:function(){if(adminmessage.room==""){return}if(adminmessage.pair==""){return}var a={room:adminmessage.room,location:adminmessage.location,instance:adminmessage.instance,pair:adminmessage.pair};if(adminmessage.cursor){a.cursor=adminmessage.cursor}$.ajax({url:"/services/adminmessage/init?i="+adminmessage.destination,type:"GET",cache:false,dataType:"text",data:$.param(a),success:adminmessage.onInitSuccess,error:adminmessage.onInitError})},onInitSuccess:function(b){try{adminmessage.inbox.html(b);var a=document.getElementById("adminmessage-inbox");a.scrollTop=a.scrollHeight;$("#adminmessage_panel").fadeIn("slow")}catch(c){adminmessage.onInitError();return}},onInitError:function(a){adminmessage.init()},getInvites:function(){if(adminmessage.room==""){return}$.head("/services/adminmessage/invites?i="+adminmessage.destination+"&room="+adminmessage.room+"&instance="+adminmessage.instance+"&userid="+adminmessage.user+"&location="+adminmessage.location,{},function(a){$.each(a,function(b,d){if(b=="X-AdminInvite"){try{adminmessage.showInvite(d)}catch(c){console.log("No Admin Invites Available")}}})},adminmessage.errorSleepTime-2000);window.setTimeout(adminmessage.getInvites,adminmessage.errorSleepTime)},setPair:function(b){console.log("Setting Pair!");var c=b.getAttribute("id").split("-");var a=$("#userid").html();if(a==c[1]){return}var d=(c[1]>a)?a+"-"+c[1]:c[1]+"-"+a;console.log("using id "+c[1]+" with mid "+a+" = "+d);$("#adminmessage-pairid").html(d);adminmessage.pair=d;$("#adminmessage-toid").html(c[1]);return c[1]},getPair:function(){console.log("Getting Pair!");var a=$("#userid").html();id=$("#adminmessage-pairid").html().replace(a,"");id=id.replace("-","");return id},showInvite:function(header){console.log("Show Invite");var invite=eval("("+header+")");if(invite.to!=adminmessage.user){return}if($("#admininvite-"+invite.author).length==0){console.log("Show Invite: "+invite.type);if(invite.type=="sc"){console.log($.cookie("sc"));if((adminmessage.location=="theater")&&($.cookie("sc")!="sent")){console.log("This user didn't send the capture");adminmessage.clearPairInvite(adminmessage.leaveRoom)}else{console.log("This user sent the capture");adminmessage.deadletter++;if(adminmessage.location=="lobby"){html='<p><a onclick="adminmessage.doRedirect(this)" id="surrender-'+invite.author+'" name="surrender-'+invite.author+'" cursor="'+invite.cursor+'">The seat is ready, you can enter the theater by clicking here.</a></p>';error.showError("default","SEAT READY",html,"left")}if(adminmessage.deadletter==10){adminmessage.deadletter=0;adminmessage.clearCursorInvite(invite.cursor,0)}}}else{if(invite.type=="sk"){if(adminmessage.location=="theater"){adminmessage.clearPairInvite(adminmessage.blockRoom)}}else{if(invite.type=="sr"){if(adminmessage.location=="theater"){html='<p id="invite-'+invite.pair+'"><a onclick="adminmessage.surrenderSeat(this)" id="admininvite-'+invite.author+'" name="admininvite-'+invite.author+'" cursor="'+invite.cursor+'">'+invite.from+" has asked to take your seat. Click this message to allow this.</a></p>";if((adminmessage.pair!=invite.pair)||($("#adminmessage_panel:visible").length==0)){error.showError("default","SEAT REQUEST",html,"left")}}else{if(adminmessage.location=="lobby"){adminmessage.clearPairInvite(null)}}}else{if(invite.type=="ss"){if(adminmessage.location=="lobby"){console.log("Someone surrendered the seat");if(adminmessage.location=="lobby"){html='<p><a onclick="adminmessage.doRedirect(this)" id="surrender-'+invite.author+'" name="surrender-'+invite.author+'" cursor="'+invite.cursor+'">The seat is ready, you can enter the theater by clicking here.</a></p>';error.showError("default","SEAT READY",html,"left")}}else{if(adminmessage.location=="theater"){adminmessage.clearPairInvite(adminmessage.leaveRoom)}}}}}}}},requestSeat:function(){var a={adminmessagebody:adminmessage.seatrequest,type:"sr"};$.postAdminJSON("/services/adminmessage/post",a)},captureSeat:function(element){console.log("Capture Seat");id=adminmessage.getPair();$.cookie("sc","sent",{path:"/"});var args={pair:adminmessage.pair,to:id,room:adminmessage.room,seat:adminmessage.seat};$.ajax({url:"/services/Lobby/capture?i="+adminmessage.destination,type:"GET",cache:false,dataType:"text",data:$.param(args),success:function(response){adminmessage.notifySeat(eval("("+response+")"))},error:function(response){console.log("Failure in Seat Capture");error.showError("error","Your seat capture was unsuccessful.")}})},notifySeat:function(a){console.log("Notify Seat!");if(a.response.result=="success"){var b={adminmessagebody:adminmessage.seatresponse,type:"sc"};$.postAdminJSON("/services/adminmessage/post",b,adminmessage.takeSeat)}},takeSeat:function(){console.log("Takin Seat!");console.log(adminmessage.location);if(adminmessage.location=="lobby"){console.log("Showing Error Now!");html='<p><a onclick="adminmessage.doRedirect(this)">The seat is ready, you can enter the theater by clicking here.</a></p>';error.showError("default","SEAT READY",html,"left")}},doRedirect:function(a){try{adminmessage.clearCursorInvite(a.getAttribute("cursor"),a.getAttribute("id"))}catch(b){}window.location="/theater/"+adminmessage.room+"/"+adminmessage.seat},blockSeat:function(element){console.log("Capture Seat");id=adminmessage.setPair(element);var args={pair:adminmessage.pair,to:id,room:adminmessage.room,seat:adminmessage.seat};$.ajax({url:"/services/Lobby/kill",type:"GET",cache:false,dataType:"text",data:$.param(args),success:function(response){adminmessage.killSeat(eval("("+response+")"))},error:function(response){console.log("Failure in Seat Block");error.showError("error","Seat block was unsuccessful.")}})},killSeat:function(a){console.log("Notify Seat!");if(a.response.result=="success"){var b={adminmessagebody:adminmessage.seatresponse,type:"sk"};$.postAdminJSON("/services/adminmessage/post",b)}},blockRoom:function(){console.log("Blocking Room");if(adminmessage.location!="lobby"){window.location="/lobby/"+adminmessage.room+"/"+adminmessage.seat+"?code=block"}},exitSeat:function(){console.log("exit seat");window.location="/services/Lobby/leave?room="+adminmessage.room+"&seat="+adminmessage.seat+"&code=exit"},dismiss:function(a){console.log("dismiss");try{adminmessage.clearCursorInvite(a.getAttribute("cursor"),a.getAttribute("id"))}catch(b){}},surrenderSeat:function(b){console.log("surrender seat");id=adminmessage.setPair(b);adminmessage.clearCursorInvite(b.getAttribute("cursor"),b.getAttribute("id"));var a={pair:adminmessage.pair,to:id,room:adminmessage.room,seat:adminmessage.seat};$.ajax({url:"/services/Lobby/surrender",type:"GET",cache:false,dataType:"text",data:$.param(a),complete:adminmessage.notifyLobby})},notifyLobby:function(a){var b={adminmessagebody:adminmessage.seatresponse,type:"ss"};$.postAdminJSON("/services/adminmessage/post",b,adminmessage.leaveRoom)},leaveRoom:function(){console.log("leave room");console.log($.cookie("sc"));console.log(adminmessage.location);if(adminmessage.location=="theater"){window.location="/lobby/"+adminmessage.room+"/"+adminmessage.seat+"/surrender?code=exit"}},clearCursorInvite:function(b,c){var a={cursor:b};$.ajax({url:"/services/adminmessage/cursor_invite?i="+adminmessage.destination,type:"GET",cache:false,dataType:"text",data:$.param(a)})},clearPairInvite:function(b){console.log("Clear Pair Invite");var a={room:adminmessage.room,to:adminmessage.user};$.ajax({url:"/services/adminmessage/pair_invite?i="+adminmessage.destination,type:"GET",cache:false,dataType:"text",data:$.param(a),success:b})}};$(document).ready(function(){if(!window.console){window.console={}}if(!window.console.log){window.console.log=function(){}}if(window.location.pathname.match(/theater/)){adminmessage.location="theater"}if(window.location.pathname.match(/screening/)){adminmessage.location="screening"}if(window.location.pathname.match(/lobby/)){adminmessage.location="lobby"}adminmessage.construct();adminmessage.getInvites()});